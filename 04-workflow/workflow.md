# 🔄 Workflow และสถานะเอกสาร

> รองรับทั้ง **รายจ่าย (Expense)** และ **รายรับ (Income)**
> 
> - **Expense**: ใช้ workflow เดิม (Draft → Review → Export → Booked)
> - **Income**: เพิ่ม payment_status tracking (pending → paid) ใน Phase 2

## State Diagram

```
                    ┌──────────────┐
                    │    Draft     │ อัปโหลดแล้ว ข้อมูลยังไม่ครบ
                    └──────┬───────┘
                           │ ส่งตรวจ
                           ▼
                ┌──────────────────────┐
                │   Pending Review     │ รอบัญชีตรวจ
                └──────────┬───────────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
          ▼                ▼                ▼
   ┌────────────┐  ┌──────────────┐  ┌────────────┐
   │ Need Info  │  │Ready to Export│  │  Rejected  │
   │ ขอเพิ่ม    │  │ พร้อม export │  │ ปฏิเสธ     │
   └─────┬──────┘  └──────┬───────┘  └────────────┘
         │                │
         │ แก้ไขแล้ว      │ Export
         └───────►        ▼
                  ┌──────────────┐
                  │   Exported   │ export แล้ว
                  └──────┬───────┘
                         │ บันทึกบัญชีแล้ว
                         ▼
                  ┌──────────────┐
                  │    Booked    │ บันทึกเข้าระบบแล้ว
                  └──────┬───────┘
                         │ (ถ้าต้องยกเลิก)
                         ▼
                  ┌──────────────┐
                  │     Void     │ ยกเลิก (หลังบันทึก)
                  └──────────────┘
```

---

## สถานะทั้งหมด

| # | Status | Thai | Description |
|---|--------|------|-------------|
| 1 | `draft` | แบบร่าง | อัปโหลดเข้าแล้ว แต่ข้อมูลยังไม่ครบ |
| 2 | `pending_review` | รอตรวจ | ส่งแล้ว รอบัญชีตรวจ |
| 3 | `need_info` | ขอข้อมูลเพิ่ม | บัญชีขอเพิ่ม/ระบบตรวจพบไม่สมบูรณ์ |
| 4 | `ready_to_export` | พร้อม Export | ข้อมูลครบพร้อม export |
| 5 | `exported` | Export แล้ว | Export ไฟล์แล้ว รอบันทึกเข้าระบบบัญชี |
| 6 | `booked` | บันทึกแล้ว | บันทึกเข้าระบบบัญชีแล้ว |
| 7 | `rejected` | ปฏิเสธ | ถูกปฏิเสธ/ไม่สามารถใช้ได้ |
| 8 | `void` | ยกเลิก | ยกเลิกหลังจากบันทึกแล้ว (มีเหตุผล) |

### Payment Status (สำหรับเอกสารรายรับ - Phase 2)

| # | Status | Thai | Description |
|---|--------|------|-------------|
| 1 | `pending` | รอชำระ | ออกใบแจ้งหนี้แล้ว รอลูกค้าจ่าย |
| 2 | `partial` | จ่ายบางส่วน | ลูกค้าจ่ายมาบางส่วน |
| 3 | `paid` | จ่ายครบ | ลูกค้าจ่ายครบแล้ว |
| 4 | `overdue` | เกินกำหนด | เกินวันครบกำหนดชำระ |

> ⚠️ **หมายเหตุ**: Payment Status ใช้กับเอกสาร `transaction_type = income` เท่านั้น

---

## Transition Rules

### จาก Draft
| To Status | Condition | Actor |
|-----------|-----------|-------|
| `pending_review` | กรอกข้อมูลครบ required fields | Staff |

### จาก Pending Review
| To Status | Condition | Actor |
|-----------|-----------|-------|
| `need_info` | ข้อมูลไม่ครบ/ต้องการรายละเอียด | Accounting |
| `ready_to_export` | ข้อมูลครบถูกต้อง | Accounting |
| `rejected` | เอกสารไม่ถูกต้อง/ใช้ไม่ได้ | Accounting |

### จาก Need Info
| To Status | Condition | Actor |
|-----------|-----------|-------|
| `pending_review` | เพิ่มข้อมูลแล้ว | Staff |

### จาก Ready to Export
| To Status | Condition | Actor |
|-----------|-----------|-------|
| `exported` | Export ไฟล์ออกจากระบบ | Accounting |

### จาก Exported
| To Status | Condition | Actor |
|-----------|-----------|-------|
| `booked` | บันทึกเข้าระบบบัญชีแล้ว | Accounting |

### จาก Booked
| To Status | Condition | Actor |
|-----------|-----------|-------|
| `void` | ต้องยกเลิก (มีเหตุผลระบุ) | Admin |

---

## Status Colors (UI)

| Status | Color | Badge |
|--------|-------|-------|
| `draft` | Gray | ⚪ |
| `pending_review` | Blue | 🔵 |
| `need_info` | Orange | 🟠 |
| `ready_to_export` | Green | 🟢 |
| `exported` | Cyan | 🔵 |
| `booked` | Purple | 🟣 |
| `rejected` | Red | 🔴 |
| `void` | Dark Gray | ⚫ |

---

## Workflow by Role

### Staff Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Staff Flow                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. อัปโหลด          2. กรอกข้อมูล        3. ส่งตรวจ           │
│  ┌─────────┐         ┌─────────┐         ┌─────────┐           │
│  │ 📷/📁   │────────▶│ ✏️ Form │────────▶│   ✅    │           │
│  │ Upload  │         │  Fill   │         │ Submit  │           │
│  └─────────┘         └─────────┘         └────┬────┘           │
│                                               │                 │
│                                               ▼                 │
│  4. รอผล                                 ┌─────────┐            │
│  ┌─────────┐◀────────────────────────────│ Pending │            │
│  │ ⏳ Wait │                             │ Review  │            │
│  └────┬────┘                             └─────────┘            │
│       │                                                         │
│       ▼                                                         │
│  ถ้า Need Info          ถ้า Approved                            │
│  ┌─────────┐            ┌─────────┐                            │
│  │ 📝 ตอบ  │            │ ✅ Done │                            │
│  │ Comment │            │         │                            │
│  └────┬────┘            └─────────┘                            │
│       │                                                         │
│       └───────────▶ กลับไป Submit ใหม่                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Accounting Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Accounting Flow                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. รับเอกสาร         2. ตรวจสอบ          3. ตัดสินใจ           │
│  ┌─────────┐         ┌─────────┐         ┌─────────────┐       │
│  │ 📥 Inbox│────────▶│ 👀 View │────────▶│ ✅❌❓      │       │
│  │         │         │ + OCR   │         │ Approve/Ask │       │
│  └─────────┘         └─────────┘         └──────┬──────┘       │
│                                                 │               │
│                         ┌───────────────────────┼────────┐      │
│                         │                       │        │      │
│                         ▼                       ▼        ▼      │
│                  ┌─────────────┐      ┌──────────┐  ┌──────┐   │
│                  │ Need Info   │      │ Ready to │  │Reject│   │
│                  │ ขอข้อมูลเพิ่ม│      │  Export  │  │      │   │
│                  └─────────────┘      └────┬─────┘  └──────┘   │
│                                            │                    │
│                                            ▼                    │
│  4. Export                          ┌─────────────┐            │
│  ┌─────────┐                        │ 📤 Export   │            │
│  │ Excel/  │◀───────────────────────│ PEAK/Excel  │            │
│  │ PEAK    │                        └──────┬──────┘            │
│  └─────────┘                               │                    │
│                                            ▼                    │
│  5. บันทึก                          ┌─────────────┐            │
│  ┌─────────┐                        │ 📊 บันทึก   │            │
│  │ ✅ Done │◀───────────────────────│ เข้าระบบบัญชี│            │
│  └─────────┘                        └─────────────┘            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Bulk Actions

### Actions ที่ทำได้
| Action | Description | Available Status |
|--------|-------------|------------------|
| **Bulk Approve** | ✅ เปลี่ยนสถานะเป็น ready_to_export | pending_review |
| **Bulk Reject** | ❌ เปลี่ยนสถานะเป็น rejected + ใส่เหตุผล | pending_review, need_info |
| **Bulk Export** | 📤 Export เอกสารที่เลือกเป็น Excel/ZIP | ready_to_export |
| **Bulk Assign** | 🏷️ กำหนดหมวด/ศูนย์ต้นทุนพร้อมกัน | any (not booked/void) |
| **Bulk Add to Group** | 📁 เพิ่มเข้า Expense Group | any (not booked/void) |

---

## Fiscal Period Lock

### Rules
1. เอกสารที่ `fiscal_month` อยู่ในงวดที่ `closed` จะแก้ไขไม่ได้
2. Admin สามารถ reopen งวดได้ (พร้อม audit log)
3. การ reopen ต้องมีเหตุผลและบันทึกประวัติ

### Status Flow
```
open ───▶ closing ───▶ closed
                         │
                         │ (Admin reopen)
                         ▼
                       open
```

---

## Document Exchange Tracking (Phase 2)

### การเชื่อมต่อกับ Workflow หลัก

เมื่อเอกสารมีการหัก ณ ที่จ่าย ระบบจะสร้าง **DocumentExchange** เพื่อติดตามการส่ง-รับเอกสารภาษี

```
┌─────────────────────────────────────────────────────────────────┐
│                    Document + Exchange Flow                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    DOCUMENT FLOW (เดิม)                   │  │
│  │  Draft → Pending → Ready → Exported → Booked             │  │
│  └─────────────────────────────┬────────────────────────────┘  │
│                                │                                │
│                                │ ถ้ามีหัก ณ ที่จ่าย             │
│                                ▼                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │               EXCHANGE FLOW (ใหม่)                        │  │
│  │                                                          │  │
│  │  📤 ฝั่งซื้อ (Outgoing):                                 │  │
│  │  pending → issued → sent → confirmed                     │  │
│  │  (รอออก)  (ออกแล้ว) (ส่งแล้ว) (ยืนยันรับ)                 │  │
│  │                                                          │  │
│  │  📥 ฝั่งขาย (Incoming):                                  │  │
│  │  pending → received                                      │  │
│  │  (รอรับ)   (ได้รับแล้ว)                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### WHT Detection: ระบบรู้ได้อย่างไรว่ามีหัก ณ ที่จ่าย

```
┌─────────────────────────────────────────────────────────────────┐
│                    WHT Detection Flow                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1️⃣ Staff อัปโหลดเอกสาร                                        │
│     └─ เลือกหมวด: "ค่าแรง / ฟรีแลนซ์"                           │
│                    │                                            │
│                    ▼                                            │
│  2️⃣ ระบบตรวจหมวด (InternalCategory.wht_suggestion)            │
│     ├─ หมวดนี้ตั้งค่าไว้ว่า: wht_suggestion = "usually"        │
│     └─ default_wht_rate = 3%                                   │
│                    │                                            │
│                    ▼                                            │
│  3️⃣ ระบบแนะนำให้ Staff                                         │
│     ┌─────────────────────────────────────────────────────┐    │
│     │ 💡 หมวดนี้มักมีหัก ณ ที่จ่าย                          │    │
│     │                                                     │    │
│     │ ☑️ มีหัก ณ ที่จ่าย                                   │    │
│     │    อัตรา: [3%] ▼                                    │    │
│     │                                                     │    │
│     │ (Staff สามารถเปลี่ยน/ปิดได้)                        │    │
│     └─────────────────────────────────────────────────────┘    │
│                    │                                            │
│                    ▼                                            │
│  4️⃣ Staff เลือก Vendor (ถ้ามีในระบบ)                           │
│     └─ ระบบตรวจ Vendor.wht_applicable                          │
│        ├─ ถ้า Vendor เป็นบุคคล (Freelancer) → แนะนำ WHT        │
│        └─ ถ้า Vendor เคยมี WHT → แนะนำตามประวัติ               │
│                    │                                            │
│                    ▼                                            │
│  5️⃣ บัญชีตรวจสอบ (Final Decision)                              │
│     └─ บัญชีสามารถแก้ไข/ยืนยัน WHT ได้                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### แหล่งข้อมูลที่ใช้แนะนำ WHT

| แหล่ง | Field | วิธีใช้ |
|-------|-------|--------|
| **หมวดค่าใช้จ่าย** | `InternalCategory.wht_suggestion` | ถ้า = "usually" → **แนะนำ** (ไม่บังคับ) |
| **หมวดค่าใช้จ่าย** | `InternalCategory.default_wht_rate` | ใช้เป็นค่าเริ่มต้น (1%, 3%, 5%) |
| **Vendor** | `Vendor.wht_applicable` | ถ้า = true → **แนะนำ** (ไม่บังคับ) |
| **Vendor** | `Vendor.vendor_type` | ถ้า = "บุคคล" → มักมี WHT |
| **Vendor** | `Vendor.default_wht_rate` | ใช้อัตราจาก Vendor ถ้ามี |
| **ประวัติ** | เอกสารเก่าจาก Vendor เดียวกัน | ถ้าเคยมี WHT → แนะนำเหมือนเดิม |

### ⚠️ สำคัญ: แนะนำ ไม่ใช่บังคับ

ระบบเข้าใจว่า **Vendor เดียวกัน หมวดเดียวกัน อาจมี/ไม่มี WHT ต่างกันได้**

**ตัวอย่างจริง:**
```
Vendor: คุณสมชาย (Freelancer)
├── จ้างออกแบบเว็บ ฿10,000    → ✅ มี WHT 3%
├── ซื้อ License จากเขา ฿5,000 → ❌ ไม่มี WHT (ซื้อของ)
└── จ้างสอน Workshop ฿8,000   → ✅ มี WHT 3%

หมวด: ค่าโฆษณาและการตลาด
├── จ้างทำ Content ฿15,000    → ✅ มี WHT 3%
├── ค่า Facebook Ads ฿20,000  → ❌ ไม่มี WHT (จ่ายต่างประเทศ)
└── จ้างถ่ายรูปสินค้า ฿8,000   → ✅ มี WHT 3%
```

**หลักการ:**
- ระบบ **แนะนำ** จากประวัติ/หมวด/Vendor
- Staff **เลือก** ว่าจะเปิด/ปิด WHT ได้ทุกครั้ง
- บัญชี **ตรวจสอบ** และแก้ไขได้ก่อน approve

### ลำดับความสำคัญในการแนะนำ

```
1. Vendor.wht_applicable (ถ้ามี Vendor ในระบบ)
   ↓ ถ้าไม่มี
2. InternalCategory.wht_suggestion
   ↓ ถ้าไม่แน่ใจ
3. ถามผู้ใช้
```

---

### Trigger Points (จุดที่สร้าง Exchange)

| เหตุการณ์ | สิ่งที่เกิดขึ้น | Exchange Type |
|----------|---------------|---------------|
| บันทึกเอกสารที่มี `wht_applicable = true` | สร้าง Exchange อัตโนมัติ | `outgoing` |
| บัญชี Approve เอกสาร Invoice ที่ลูกค้าหัก WHT | สร้าง Exchange อัตโนมัติ | `incoming` |
| บัญชีสร้าง Exchange เอง | สร้างด้วยตนเอง | ทั้งสองแบบ |

### Workflow รวม: ฝั่งซื้อ (จ้าง Freelancer)

```
┌─────────────────────────────────────────────────────────────────┐
│  ตัวอย่าง: จ้าง Freelancer ฿10,000 (หัก 3%)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Staff อัปโหลดใบเสร็จค่าจ้าง                                 │
│     └─ Document: draft → pending_review                        │
│                                                                 │
│  2. บัญชีตรวจ + ระบุว่าหัก ณ ที่จ่าย 3%                         │
│     ├─ Document: ready_to_export                               │
│     └─ Exchange: สร้างอัตโนมัติ (status: pending)              │
│                                                                 │
│  3. บัญชี Export + บันทึกเข้าระบบ                               │
│     └─ Document: exported → booked                             │
│                                                                 │
│  4. บัญชีออกหนังสือหัก ณ ที่จ่าย                                │
│     └─ Exchange: pending → issued                              │
│                                                                 │
│  5. บัญชีส่งให้ Freelancer (email/ไปรษณีย์)                     │
│     └─ Exchange: issued → sent                                 │
│                                                                 │
│  6. Freelancer ยืนยันว่าได้รับแล้ว                              │
│     └─ Exchange: sent → confirmed ✅                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Workflow รวม: ฝั่งขาย (ลูกค้าจ้างเรา)

```
┌─────────────────────────────────────────────────────────────────┐
│  ตัวอย่าง: ลูกค้าจ้างเราทำงาน ฿50,000 (เขาหัก 3%)               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. บัญชีบันทึก Invoice ที่ส่งลูกค้า                            │
│     └─ Document: (อาจไม่อยู่ในระบบ หรืออยู่เป็น Invoice)        │
│                                                                 │
│  2. บัญชีสร้าง Exchange ว่าต้องรับหนังสือหัก ณ ที่จ่าย          │
│     └─ Exchange: สร้างใหม่ (status: pending, type: incoming)   │
│                                                                 │
│  3. รอลูกค้าส่งหนังสือรับรองหัก ณ ที่จ่ายมาให้                  │
│     └─ Exchange: pending (⚠️ แจ้งเตือนถ้าค้างนาน)              │
│                                                                 │
│  4. ได้รับหนังสือจากลูกค้า                                      │
│     └─ Exchange: pending → received ✅                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Exchange Status Details

| Status | Thai | Description | ใช้กับ |
|--------|------|-------------|--------|
| `pending` | รอดำเนินการ | ยังไม่ได้ออก/ยังไม่ได้รับ | ทั้งสองแบบ |
| `issued` | ออกแล้ว | ออกเอกสารแล้ว รอส่ง | outgoing |
| `sent` | ส่งแล้ว | ส่งให้คู่ค้าแล้ว รอยืนยัน | outgoing |
| `confirmed` | ยืนยันรับแล้ว | คู่ค้ายืนยันว่าได้รับแล้ว | outgoing |
| `received` | ได้รับแล้ว | ได้รับเอกสารจากคู่ค้าแล้ว | incoming |
| `cancelled` | ยกเลิก | ยกเลิกการติดตาม | ทั้งสองแบบ |

### การแสดงผลใน Document Detail

เมื่อเอกสารมี Exchange ที่เกี่ยวข้อง จะแสดงใน Document Detail:

```
┌─────────────────────────────────────────────────────────────────┐
│  📄 DOC-202601-0015 - ค่าจ้าง Freelancer    [Booked ✅]         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ... (ข้อมูลเอกสาร) ...                                         │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📋 เอกสารที่ต้องติดตาม                        [+ เพิ่ม] │   │
│  │ ───────────────────────────────────────────────────────│   │
│  │                                                         │   │
│  │  📤 หนังสือหัก ณ ที่จ่าย → คุณสมชาย                     │   │
│  │     ฿300 (3%)                                          │   │
│  │     สถานะ: 📨 ส่งแล้ว (13 ม.ค. ทาง email)              │   │
│  │     ⏳ รอยืนยันรับ 3 วัน                                │   │
│  │     [ยืนยันรับแล้ว] [ดูประวัติ]                         │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Alert Rules

| เงื่อนไข | การแจ้งเตือน |
|---------|-------------|
| Outgoing ค้าง `pending` > 7 วัน | แจ้งเตือน "ยังไม่ได้ออกหนังสือหัก ณ ที่จ่าย" |
| Outgoing ค้าง `sent` > 7 วัน | แจ้งเตือน "รอยืนยันรับนานเกินไป" |
| Incoming ค้าง `pending` > 14 วัน | แจ้งเตือน "ยังไม่ได้รับหนังสือหัก ณ ที่จ่าย" |
