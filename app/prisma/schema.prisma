// Accounting Document Hub - Database Schema
// Multi-tenant document management system

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  taxId     String?  @map("tax_id")
  address   String?
  phone     String?
  email     String?
  logo      String?
  settings  Json     @default("{}")
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members      OrganizationMember[]
  documents    Document[]
  contacts     Contact[]
  costCenters  CostCenter[]
  categories   Category[]
  fiscalPeriods FiscalPeriod[]
  exportHistories ExportHistory[]

  @@map("organizations")
}

enum Plan {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  avatarUrl     String?  @map("avatar_url")
  supabaseId    String   @unique @map("supabase_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  memberships   OrganizationMember[]
  documents     Document[]           @relation("SubmittedBy")
  reviewedDocs  Document[]           @relation("ReviewedBy")
  comments      Comment[]
  activityLogs  ActivityLog[]

  @@map("users")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  role           MemberRole   @default(STAFF)
  isActive       Boolean      @default(true) @map("is_active")
  invitedAt      DateTime     @default(now()) @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

enum MemberRole {
  OWNER
  ADMIN
  ACCOUNTING
  STAFF
}

// ============================================
// MASTER DATA
// ============================================

model Contact {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  name           String
  contactType    ContactType   @default(INDIVIDUAL) @map("contact_type")
  contactRole    ContactRole   @default(VENDOR) @map("contact_role")
  taxId          String?       @map("tax_id")
  address        String?
  phone          String?
  email          String?
  whtApplicable  Boolean       @default(false) @map("wht_applicable")
  isActive       Boolean       @default(true) @map("is_active")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@map("contacts")
}

enum ContactType {
  INDIVIDUAL
  COMPANY
}

enum ContactRole {
  VENDOR
  CUSTOMER
  BOTH
}

model CostCenter {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  code           String
  name           String
  description    String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@unique([organizationId, code])
  @@map("cost_centers")
}

model Category {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  code           String
  name           String
  categoryType   CategoryType @default(EXPENSE) @map("category_type")
  peakAccountCode String?     @map("peak_account_code")
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@unique([organizationId, code])
  @@map("categories")
}

enum CategoryType {
  EXPENSE
  INCOME
}

model FiscalPeriod {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  name           String       // e.g., "2024-01", "มกราคม 2567"
  year           Int
  month          Int
  startDate      DateTime     @map("start_date")
  endDate        DateTime     @map("end_date")
  status         PeriodStatus @default(OPEN)
  closedAt       DateTime?    @map("closed_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@unique([organizationId, year, month])
  @@map("fiscal_periods")
}

enum PeriodStatus {
  OPEN
  CLOSING
  CLOSED
}

// ============================================
// DOCUMENTS (Core)
// ============================================

model Document {
  id              String          @id @default(cuid())
  organizationId  String          @map("organization_id")
  docNumber       String          @map("doc_number")
  transactionType TransactionType @default(EXPENSE) @map("transaction_type")
  docType         DocType         @default(RECEIPT) @map("doc_type")
  docDate         DateTime        @map("doc_date")
  dueDate         DateTime?       @map("due_date")
  
  // Amounts
  subtotal        Decimal         @default(0) @db.Decimal(15, 2)
  vatAmount       Decimal         @default(0) @map("vat_amount") @db.Decimal(15, 2)
  whtAmount       Decimal         @default(0) @map("wht_amount") @db.Decimal(15, 2)
  totalAmount     Decimal         @default(0) @map("total_amount") @db.Decimal(15, 2)
  
  // VAT Info
  vatRate         Decimal?        @map("vat_rate") @db.Decimal(5, 2)
  isVatInclusive  Boolean         @default(true) @map("is_vat_inclusive")
  hasValidVat     Boolean         @default(false) @map("has_valid_vat")
  
  // WHT Info
  hasWht          Boolean         @default(false) @map("has_wht")
  whtRate         Decimal?        @map("wht_rate") @db.Decimal(5, 2)
  whtType         String?         @map("wht_type")
  
  // Status
  status          DocumentStatus  @default(DRAFT)
  paymentStatus   PaymentStatus?  @map("payment_status")
  paymentMethod   PaymentMethod?  @map("payment_method")
  
  // References
  externalRef     String?         @map("external_ref") // เลขที่ใบเสร็จ/ใบกำกับภาษี
  description     String?
  notes           String?
  
  // Relations
  contactId       String?         @map("contact_id")
  costCenterId    String?         @map("cost_center_id")
  categoryId      String?         @map("category_id")
  fiscalPeriodId  String?         @map("fiscal_period_id")
  submittedById   String          @map("submitted_by_id")
  reviewedById    String?         @map("reviewed_by_id")
  expenseGroupId  String?         @map("expense_group_id")
  
  // Timestamps
  submittedAt     DateTime?       @map("submitted_at")
  reviewedAt      DateTime?       @map("reviewed_at")
  exportedAt      DateTime?       @map("exported_at")
  bookedAt        DateTime?       @map("booked_at")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  organization  Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact       Contact?         @relation(fields: [contactId], references: [id])
  costCenter    CostCenter?      @relation(fields: [costCenterId], references: [id])
  category      Category?        @relation(fields: [categoryId], references: [id])
  fiscalPeriod  FiscalPeriod?    @relation(fields: [fiscalPeriodId], references: [id])
  submittedBy   User             @relation("SubmittedBy", fields: [submittedById], references: [id])
  reviewedBy    User?            @relation("ReviewedBy", fields: [reviewedById], references: [id])
  expenseGroup  ExpenseGroup?    @relation(fields: [expenseGroupId], references: [id])
  
  files         DocumentFile[]
  lines         DocumentLine[]
  comments      Comment[]
  activityLogs  ActivityLog[]

  @@unique([organizationId, docNumber])
  @@index([organizationId, status])
  @@index([organizationId, docDate])
  @@index([organizationId, transactionType])
  @@map("documents")
}

enum TransactionType {
  EXPENSE
  INCOME
}

enum DocType {
  SLIP          // สลิปโอนเงิน
  RECEIPT       // ใบเสร็จรับเงิน
  TAX_INVOICE   // ใบกำกับภาษี
  INVOICE       // ใบแจ้งหนี้
  QUOTATION     // ใบเสนอราคา
  PURCHASE_ORDER // ใบสั่งซื้อ
  DELIVERY_NOTE // ใบส่งของ
  OTHER
}

enum DocumentStatus {
  DRAFT           // แบบร่าง
  PENDING_REVIEW  // รอตรวจ
  NEED_INFO       // ขอข้อมูลเพิ่ม
  READY_TO_EXPORT // พร้อม Export
  EXPORTED        // Export แล้ว
  BOOKED          // บันทึกบัญชีแล้ว
  REJECTED        // ปฏิเสธ
  VOID            // ยกเลิก
}

enum PaymentStatus {
  PENDING   // รอชำระ
  PARTIAL   // จ่ายบางส่วน
  PAID      // จ่ายครบ
  OVERDUE   // เกินกำหนด
}

enum PaymentMethod {
  CASH
  TRANSFER
  CREDIT_CARD
  CHEQUE
  OTHER
}

model DocumentFile {
  id          String   @id @default(cuid())
  documentId  String   @map("document_id")
  fileName    String   @map("file_name")
  fileUrl     String   @map("file_url")
  fileSize    Int      @map("file_size")
  mimeType    String   @map("mime_type")
  checksum    String?  // MD5 for duplicate detection
  pageOrder   Int      @default(0) @map("page_order")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_files")
}

model DocumentLine {
  id          String   @id @default(cuid())
  documentId  String   @map("document_id")
  lineNumber  Int      @map("line_number")
  description String?
  quantity    Decimal  @default(1) @db.Decimal(15, 4)
  unitPrice   Decimal  @default(0) @map("unit_price") @db.Decimal(15, 2)
  amount      Decimal  @default(0) @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_lines")
}

// ============================================
// EXPENSE GROUPS
// ============================================

model ExpenseGroup {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  totalAmount    Decimal  @default(0) @map("total_amount") @db.Decimal(15, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  documents Document[]

  @@map("expense_groups")
}

// ============================================
// COMMENTS & ACTIVITY
// ============================================

model Comment {
  id         String   @id @default(cuid())
  documentId String   @map("document_id")
  userId     String   @map("user_id")
  content    String
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

model ActivityLog {
  id         String   @id @default(cuid())
  documentId String?  @map("document_id")
  userId     String   @map("user_id")
  action     String
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  document Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

// ============================================
// EXPORT
// ============================================

model ExportHistory {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  exportType     ExportType @map("export_type")
  fileName       String     @map("file_name")
  fileUrl        String?    @map("file_url")
  documentIds    String[]   @map("document_ids")
  documentCount  Int        @map("document_count")
  exportedById   String     @map("exported_by_id")
  createdAt      DateTime   @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("export_histories")
}

enum ExportType {
  EXCEL_GENERIC
  EXCEL_PEAK
  CSV
  ZIP
}
