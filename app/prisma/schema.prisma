// Accounting Document Hub - Database Schema
// Multi-tenant document management system
// NEW: 1 Document (กล่อง) = 1 Transaction → Multiple SubDocuments

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  taxId     String?  @map("tax_id")
  address   String?
  phone     String?
  email     String?
  logo      String?
  settings  Json     @default("{}")
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members         OrganizationMember[]
  documents       Document[]
  contacts        Contact[]
  costCenters     CostCenter[]
  categories      Category[]
  fiscalPeriods   FiscalPeriod[]
  exportHistories ExportHistory[]
  savedFilters    SavedFilter[]
  notifications   Notification[]
  whtTrackings    WHTTracking[]

  @@map("organizations")
}

enum Plan {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  avatarUrl     String?  @map("avatar_url")
  supabaseId    String   @unique @map("supabase_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  memberships   OrganizationMember[]
  documents     Document[]           @relation("SubmittedBy")
  reviewedDocs  Document[]           @relation("ReviewedBy")
  comments      Comment[]
  activityLogs  ActivityLog[]
  savedFilters  SavedFilter[]
  notifications Notification[]

  @@map("users")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  role           MemberRole   @default(STAFF)
  isActive       Boolean      @default(true) @map("is_active")
  invitedAt      DateTime     @default(now()) @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

enum MemberRole {
  OWNER
  ADMIN
  ACCOUNTING
  STAFF
}

// ============================================
// MASTER DATA
// ============================================

model Contact {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  name           String
  contactType    ContactType   @default(INDIVIDUAL) @map("contact_type")
  contactRole    ContactRole   @default(VENDOR) @map("contact_role")
  taxId          String?       @map("tax_id")
  branchNo       String?       @map("branch_no") // รหัสสาขา 5 หลัก
  address        String?
  phone          String?
  email          String?
  whtApplicable  Boolean       @default(false) @map("wht_applicable")
  defaultWhtRate Decimal?      @map("default_wht_rate") @db.Decimal(5, 2)
  isActive       Boolean       @default(true) @map("is_active")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]
  whtTrackings WHTTracking[]

  @@map("contacts")
}

enum ContactType {
  INDIVIDUAL
  COMPANY
}

enum ContactRole {
  VENDOR
  CUSTOMER
  BOTH
}

model CostCenter {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  code           String
  name           String
  description    String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@unique([organizationId, code])
  @@map("cost_centers")
}

model Category {
  id              String       @id @default(cuid())
  organizationId  String       @map("organization_id")
  code            String
  name            String
  categoryType    CategoryType @default(EXPENSE) @map("category_type")
  peakAccountCode String?      @map("peak_account_code")
  whtSuggestion   WhtSuggestion @default(NONE) @map("wht_suggestion")
  defaultWhtRate  Decimal?     @map("default_wht_rate") @db.Decimal(5, 2)
  isActive        Boolean      @default(true) @map("is_active")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@unique([organizationId, code])
  @@map("categories")
}

enum CategoryType {
  EXPENSE
  INCOME
}

enum WhtSuggestion {
  NONE      // ไม่แนะนำ WHT
  SOMETIMES // บางกรณี
  USUALLY   // มักมี WHT
}

model FiscalPeriod {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  name           String       // e.g., "2024-01", "มกราคม 2567"
  year           Int
  month          Int
  startDate      DateTime     @map("start_date")
  endDate        DateTime     @map("end_date")
  status         PeriodStatus @default(OPEN)
  closedAt       DateTime?    @map("closed_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@unique([organizationId, year, month])
  @@map("fiscal_periods")
}

enum PeriodStatus {
  OPEN
  CLOSING
  CLOSED
}

// ============================================
// DOCUMENT (กล่องเอกสาร / Transaction)
// 1 Document = 1 ธุรกรรม (รายจ่าย/รายรับ)
// มีหลาย SubDocument (เอกสารแต่ละประเภท)
// ============================================

model Document {
  id              String          @id @default(cuid())
  organizationId  String          @map("organization_id")
  docNumber       String          @map("doc_number") // TXN-YYYYMM-XXXX
  transactionType TransactionType @default(EXPENSE) @map("transaction_type")
  
  // Legacy field - kept for backward compatibility
  docType         DocType         @default(RECEIPT) @map("doc_type")
  
  // Description
  description     String?         // ชื่อรายการ เช่น "ค่าบริการ IT ม.ค."
  notes           String?
  
  // Date
  docDate         DateTime        @map("doc_date") // วันที่ธุรกรรม
  dueDate         DateTime?       @map("due_date")
  
  // Amounts
  subtotal        Decimal         @default(0) @db.Decimal(15, 2)
  vatAmount       Decimal         @default(0) @map("vat_amount") @db.Decimal(15, 2)
  whtAmount       Decimal         @default(0) @map("wht_amount") @db.Decimal(15, 2)
  totalAmount     Decimal         @default(0) @map("total_amount") @db.Decimal(15, 2)
  
  // VAT Info
  vatRate         Decimal?        @map("vat_rate") @db.Decimal(5, 2)
  isVatInclusive  Boolean         @default(true) @map("is_vat_inclusive")
  hasValidVat     Boolean         @default(false) @map("has_valid_vat")
  
  // WHT Info
  hasWht          Boolean         @default(false) @map("has_wht")
  whtRate         Decimal?        @map("wht_rate") @db.Decimal(5, 2)
  whtType         String?         @map("wht_type")
  
  // Status
  status          DocumentStatus  @default(IN_PROGRESS)
  paymentStatus   PaymentStatus?  @map("payment_status")
  paymentMethod   PaymentMethod?  @map("payment_method")
  
  // Checklist Status (แทน workflow status เดิม)
  isPaid              Boolean     @default(false) @map("is_paid")              // จ่ายเงิน/รับเงินแล้ว
  hasPaymentProof     Boolean     @default(false) @map("has_payment_proof")    // มีหลักฐานการจ่าย/รับ
  hasTaxInvoice       Boolean     @default(false) @map("has_tax_invoice")      // มีใบกำกับภาษี
  hasInvoice          Boolean     @default(false) @map("has_invoice")          // มีใบแจ้งหนี้ (สำหรับรายรับ)
  whtIssued           Boolean     @default(false) @map("wht_issued")           // ออกหนังสือ WHT แล้ว (EXPENSE)
  whtSent             Boolean     @default(false) @map("wht_sent")             // ส่งหนังสือ WHT แล้ว (EXPENSE)
  whtReceived         Boolean     @default(false) @map("wht_received")         // ได้รับหนังสือ WHT แล้ว (INCOME)
  completionPercent   Int         @default(0) @map("completion_percent")       // % ความสมบูรณ์
  isComplete          Boolean     @default(false) @map("is_complete")          // เอกสารครบ 100%
  
  // References
  externalRef     String?         @map("external_ref")
  
  // Foreign Keys
  contactId       String?         @map("contact_id")
  costCenterId    String?         @map("cost_center_id")
  categoryId      String?         @map("category_id")
  fiscalPeriodId  String?         @map("fiscal_period_id")
  submittedById   String          @map("submitted_by_id")
  reviewedById    String?         @map("reviewed_by_id")
  expenseGroupId  String?         @map("expense_group_id") // Legacy - kept for backward compatibility
  
  // Timestamps
  submittedAt     DateTime?       @map("submitted_at")
  reviewedAt      DateTime?       @map("reviewed_at")
  exportedAt      DateTime?       @map("exported_at")
  bookedAt        DateTime?       @map("booked_at")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  organization  Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact       Contact?         @relation(fields: [contactId], references: [id])
  costCenter    CostCenter?      @relation(fields: [costCenterId], references: [id])
  category      Category?        @relation(fields: [categoryId], references: [id])
  fiscalPeriod  FiscalPeriod?    @relation(fields: [fiscalPeriodId], references: [id])
  submittedBy   User             @relation("SubmittedBy", fields: [submittedById], references: [id])
  reviewedBy    User?            @relation("ReviewedBy", fields: [reviewedById], references: [id])
  expenseGroup  ExpenseGroup?    @relation(fields: [expenseGroupId], references: [id]) // Legacy
  
  // Child entities
  subDocuments  SubDocument[]    // เอกสารในกล่อง
  files         DocumentFile[]   // Legacy - ไฟล์ที่ไม่ได้อยู่ใน SubDocument
  lines         DocumentLine[]   // รายการย่อย (optional)
  comments      Comment[]
  activityLogs  ActivityLog[]
  whtTrackings  WHTTracking[]

  @@unique([organizationId, docNumber])
  @@index([organizationId, status])
  @@index([organizationId, docDate])
  @@index([organizationId, transactionType])
  @@map("documents")
}

// Legacy DocType - kept for backward compatibility
enum DocType {
  SLIP          // สลิปโอนเงิน
  RECEIPT       // ใบเสร็จรับเงิน
  TAX_INVOICE   // ใบกำกับภาษี
  INVOICE       // ใบแจ้งหนี้
  QUOTATION     // ใบเสนอราคา
  PURCHASE_ORDER // ใบสั่งซื้อ
  DELIVERY_NOTE // ใบส่งของ
  OTHER
}

enum TransactionType {
  EXPENSE
  INCOME
}

enum DocumentStatus {
  IN_PROGRESS     // กำลังดำเนินการ (เอกสารยังไม่ครบ)
  COMPLETE        // เอกสารครบ 100%
  EXPORTED        // Export แล้ว
  BOOKED          // บันทึกบัญชีแล้ว
  VOID            // ยกเลิก
  
  // Legacy values - kept for backward compatibility
  DRAFT           // แบบร่าง (mapped to IN_PROGRESS)
  PENDING_REVIEW  // รอตรวจ (mapped to IN_PROGRESS)
  NEED_INFO       // ขอข้อมูลเพิ่ม (mapped to IN_PROGRESS)
  READY_TO_EXPORT // พร้อม Export (mapped to COMPLETE)
  REJECTED        // ปฏิเสธ (mapped to VOID)
}

enum PaymentStatus {
  PENDING   // รอชำระ
  PARTIAL   // จ่ายบางส่วน
  PAID      // จ่ายครบ
  OVERDUE   // เกินกำหนด
}

enum PaymentMethod {
  CASH
  TRANSFER
  CREDIT_CARD
  CHEQUE
  OTHER
}

// ============================================
// SUB-DOCUMENT (เอกสารในกล่อง)
// 1 Document → หลาย SubDocument
// แต่ละ SubDocument = เอกสารประเภทหนึ่ง (สลิป/ใบกำกับ/WHT)
// ============================================

model SubDocument {
  id          String        @id @default(cuid())
  documentId  String        @map("document_id")
  docType     SubDocType    @map("doc_type")
  docNumber   String?       @map("doc_number") // เลขที่เอกสาร (เช่น เลขใบกำกับ)
  docDate     DateTime?     @map("doc_date")
  amount      Decimal?      @db.Decimal(15, 2)
  vatAmount   Decimal?      @map("vat_amount") @db.Decimal(15, 2)
  notes       String?
  
  // Status for slot
  slotStatus  SlotStatus    @default(PENDING) @map("slot_status")
  naReason    String?       @map("na_reason") // เหตุผลที่ไม่มีเอกสาร
  
  // OCR
  ocrStatus   OcrStatus     @default(NONE) @map("ocr_status")
  ocrResult   Json?         @map("ocr_result")
  
  // Timestamps
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  document    Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  files       SubDocumentFile[]

  @@map("sub_documents")
}

// ประเภทเอกสารใน SubDocument
enum SubDocType {
  // Expense Documents
  SLIP              // สลิปโอนเงิน/หลักฐานชำระ
  TAX_INVOICE       // ใบกำกับภาษี
  INVOICE           // ใบแจ้งหนี้
  RECEIPT           // ใบเสร็จรับเงิน
  WHT_CERT_SENT     // หนังสือหัก ณ ที่จ่าย (เราออก - ต้องส่งให้คู่ค้า)
  CONTRACT          // สัญญา/ใบสั่งซื้อ
  
  // Income Documents
  QUOTATION         // ใบเสนอราคา
  // INVOICE - ใช้ร่วมกัน
  // RECEIPT - ใช้ร่วมกัน
  // TAX_INVOICE - ใช้ร่วมกัน
  WHT_CERT_RECEIVED // หนังสือหัก ณ ที่จ่าย (ถูกหัก - รอรับจากลูกค้า)
  
  OTHER             // อื่นๆ
}

enum OcrStatus {
  NONE        // ยังไม่ OCR
  PENDING     // รอ OCR
  PROCESSING  // กำลัง OCR
  COMPLETED   // OCR เสร็จ
  FAILED      // OCR ผิดพลาด
}

enum SlotStatus {
  PENDING         // รอเอกสาร
  COMPLETED       // มีแล้ว (มีไฟล์)
  NOT_APPLICABLE  // ไม่มี/N/A (ระบุเหตุผล)
}

// ============================================
// SUB-DOCUMENT FILE (ไฟล์ของเอกสารในกล่อง)
// 1 SubDocument → หลายไฟล์ได้ (หน้า-หลัง, หลายหน้า)
// ============================================

model SubDocumentFile {
  id            String   @id @default(cuid())
  subDocumentId String   @map("sub_document_id")
  fileName      String   @map("file_name")
  fileUrl       String   @map("file_url")
  fileSize      Int      @map("file_size")
  mimeType      String   @map("mime_type")
  checksum      String?  // MD5 for duplicate detection
  pageOrder     Int      @default(0) @map("page_order")
  isPrimary     Boolean  @default(false) @map("is_primary")
  createdAt     DateTime @default(now()) @map("created_at")

  subDocument SubDocument @relation(fields: [subDocumentId], references: [id], onDelete: Cascade)

  @@map("sub_document_files")
}

// ============================================
// LEGACY: DOCUMENT FILE (ไฟล์ของเอกสารเดิม)
// kept for backward compatibility
// ============================================

model DocumentFile {
  id          String   @id @default(cuid())
  documentId  String   @map("document_id")
  fileName    String   @map("file_name")
  fileUrl     String   @map("file_url")
  fileSize    Int      @map("file_size")
  mimeType    String   @map("mime_type")
  checksum    String?  // MD5 for duplicate detection
  pageOrder   Int      @default(0) @map("page_order")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_files")
}

// ============================================
// LEGACY: EXPENSE GROUPS
// kept for backward compatibility
// ============================================

model ExpenseGroup {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  totalAmount    Decimal  @default(0) @map("total_amount") @db.Decimal(15, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  documents Document[]

  @@map("expense_groups")
}

// ============================================
// DOCUMENT LINE (รายการย่อย - Optional)
// ============================================

model DocumentLine {
  id          String   @id @default(cuid())
  documentId  String   @map("document_id")
  lineNumber  Int      @map("line_number")
  description String?
  quantity    Decimal  @default(1) @db.Decimal(15, 4)
  unitPrice   Decimal  @default(0) @map("unit_price") @db.Decimal(15, 2)
  amount      Decimal  @default(0) @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_lines")
}

// ============================================
// WHT TRACKING (ติดตามหัก ณ ที่จ่าย)
// ============================================

model WHTTracking {
  id              String          @id @default(cuid())
  organizationId  String          @map("organization_id")
  documentId      String          @map("document_id")
  trackingType    WHTTrackingType @map("tracking_type")
  
  // WHT Details
  whtAmount       Decimal         @map("wht_amount") @db.Decimal(15, 2)
  whtRate         Decimal         @map("wht_rate") @db.Decimal(5, 2)
  
  // Counterparty
  contactId       String?         @map("contact_id")
  counterpartyName String?        @map("counterparty_name")
  
  // Status
  status          WHTStatus       @default(PENDING)
  
  // Dates
  issuedDate      DateTime?       @map("issued_date")
  sentDate        DateTime?       @map("sent_date")
  sentMethod      WHTSentMethod?  @map("sent_method")
  confirmedDate   DateTime?       @map("confirmed_date")
  receivedDate    DateTime?       @map("received_date")
  
  // File
  fileUrl         String?         @map("file_url")
  
  notes           String?
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  document     Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  contact      Contact?     @relation(fields: [contactId], references: [id])

  @@index([organizationId, status])
  @@index([organizationId, trackingType])
  @@map("wht_trackings")
}

enum WHTTrackingType {
  OUTGOING  // WHT ที่เราออก - ต้องส่งให้คู่ค้า
  INCOMING  // WHT ที่ถูกหัก - รอรับจากลูกค้า
}

enum WHTStatus {
  PENDING     // รอดำเนินการ
  ISSUED      // ออกเอกสารแล้ว
  SENT        // ส่งแล้ว (Outgoing)
  CONFIRMED   // ยืนยันรับแล้ว (Outgoing)
  RECEIVED    // ได้รับแล้ว (Incoming)
  CANCELLED   // ยกเลิก
}

enum WHTSentMethod {
  EMAIL
  MAIL
  HAND_DELIVERY
  OTHER
}

// ============================================
// COMMENTS & ACTIVITY
// ============================================

model Comment {
  id         String   @id @default(cuid())
  documentId String   @map("document_id")
  userId     String   @map("user_id")
  content    String
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

model ActivityLog {
  id         String   @id @default(cuid())
  documentId String?  @map("document_id")
  userId     String   @map("user_id")
  action     String
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  document Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

// ============================================
// EXPORT
// ============================================

model ExportHistory {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  exportType     ExportType @map("export_type")
  fileName       String     @map("file_name")
  fileUrl        String?    @map("file_url")
  documentIds    String[]   @map("document_ids")
  documentCount  Int        @map("document_count")
  exportedById   String     @map("exported_by_id")
  createdAt      DateTime   @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("export_histories")
}

enum ExportType {
  EXCEL_GENERIC
  EXCEL_PEAK
  CSV
  ZIP
}

// ============================================
// SAVED FILTERS
// ============================================

model SavedFilter {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  name           String
  filters        Json     // Store filter criteria as JSON
  isDefault      Boolean  @default(false) @map("is_default")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, name])
  @@map("saved_filters")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id             String           @id @default(cuid())
  organizationId String           @map("organization_id")
  userId         String           @map("user_id")
  type           NotificationType
  title          String
  message        String
  data           Json?            // Additional data (documentId, etc.)
  isRead         Boolean          @default(false) @map("is_read")
  readAt         DateTime?        @map("read_at")
  createdAt      DateTime         @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([organizationId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  DOCUMENT_SUBMITTED    // กล่องใหม่รอตรวจ
  DOCUMENT_APPROVED     // กล่องถูก approve
  DOCUMENT_REJECTED     // กล่องถูกปฏิเสธ
  DOCUMENT_NEED_INFO    // ขอข้อมูลเพิ่ม
  SUBDOC_ADDED          // มีเอกสารใหม่ในกล่อง
  DUE_DATE_REMINDER     // ใกล้ครบกำหนด
  DUE_DATE_OVERDUE      // เกินกำหนด
  WHT_PENDING           // WHT รอส่ง
  WHT_OVERDUE           // WHT เกินกำหนด
  COMMENT_ADDED         // มี comment ใหม่
  MEMBER_INVITED        // ถูกเชิญเข้าองค์กร
}
