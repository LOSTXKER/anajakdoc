// Document Hub - Database Schema
// ระบบจัดการเอกสารบัญชี
// Core Concept: 1 Box = 1 ธุรกรรม → หลาย Document → หลาย Files

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  taxId     String?  @map("tax_id")
  address   String?
  phone     String?
  email     String?
  logo      String?
  settings  Json     @default("{}")
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members         OrganizationMember[]
  boxes           Box[]
  contacts        Contact[]
  costCenters     CostCenter[]
  categories      Category[]
  fiscalPeriods   FiscalPeriod[]
  exportHistories ExportHistory[]
  savedFilters    SavedFilter[]
  notifications   Notification[]

  @@map("organizations")
}

enum Plan {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  avatarUrl     String?  @map("avatar_url")
  supabaseId    String   @unique @map("supabase_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  memberships   OrganizationMember[]
  boxes         Box[]            @relation("CreatedBy")
  comments      Comment[]
  activityLogs  ActivityLog[]
  savedFilters  SavedFilter[]
  notifications Notification[]

  @@map("users")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  role           MemberRole   @default(STAFF)
  isActive       Boolean      @default(true) @map("is_active")
  invitedAt      DateTime     @default(now()) @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

enum MemberRole {
  OWNER
  ADMIN
  ACCOUNTING
  STAFF
}

// ============================================
// MASTER DATA
// ============================================

model Contact {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  name           String
  contactType    ContactType   @default(INDIVIDUAL) @map("contact_type")
  contactRole    ContactRole   @default(VENDOR) @map("contact_role")
  taxId          String?       @map("tax_id")
  branchNo       String?       @map("branch_no")
  address        String?
  phone          String?
  email          String?
  whtApplicable  Boolean       @default(false) @map("wht_applicable")
  defaultWhtRate Decimal?      @map("default_wht_rate") @db.Decimal(5, 2)
  isActive       Boolean       @default(true) @map("is_active")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  boxes        Box[]
  whtTrackings WhtTracking[]

  @@map("contacts")
}

enum ContactType {
  INDIVIDUAL
  COMPANY
}

enum ContactRole {
  VENDOR
  CUSTOMER
  BOTH
}

model CostCenter {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  code           String
  name           String
  description    String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  boxes        Box[]

  @@unique([organizationId, code])
  @@map("cost_centers")
}

model Category {
  id              String        @id @default(cuid())
  organizationId  String        @map("organization_id")
  code            String
  name            String
  categoryType    CategoryType  @default(EXPENSE) @map("category_type")
  peakAccountCode String?       @map("peak_account_code")
  whtSuggestion   WhtSuggestion @default(NONE) @map("wht_suggestion")
  defaultWhtRate  Decimal?      @map("default_wht_rate") @db.Decimal(5, 2)
  isActive        Boolean       @default(true) @map("is_active")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  boxes        Box[]

  @@unique([organizationId, code])
  @@map("categories")
}

enum CategoryType {
  EXPENSE
  INCOME
}

enum WhtSuggestion {
  NONE
  SOMETIMES
  USUALLY
}

model FiscalPeriod {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  name           String
  year           Int
  month          Int
  startDate      DateTime     @map("start_date")
  endDate        DateTime     @map("end_date")
  status         PeriodStatus @default(OPEN)
  closedAt       DateTime?    @map("closed_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  boxes        Box[]

  @@unique([organizationId, year, month])
  @@map("fiscal_periods")
}

enum PeriodStatus {
  OPEN
  CLOSING
  CLOSED
}

// ============================================
// BOX (กล่องเอกสาร / Transaction)
// 1 Box = 1 ธุรกรรม (รายจ่าย/รายรับ/ปรับปรุง)
// มีหลาย Document (เอกสารแต่ละประเภท)
// ============================================

model Box {
  id              String        @id @default(cuid())
  organizationId  String        @map("organization_id")
  
  // === Basic Info ===
  boxNumber       String        @map("box_number")  // BOX-YYYYMM-XXXX
  title           String?                           // "ค่าบริการ IT ม.ค."
  boxType         BoxType       @default(EXPENSE)   @map("box_type")
  expenseType     ExpenseType?  @map("expense_type")
  
  // === Date ===
  boxDate         DateTime      @map("box_date")    // วันที่ธุรกรรม
  dueDate         DateTime?     @map("due_date")
  
  // === Amount ===
  totalAmount     Decimal       @default(0) @map("total_amount") @db.Decimal(15, 2)
  vatAmount       Decimal       @default(0) @map("vat_amount") @db.Decimal(15, 2)
  whtAmount       Decimal       @default(0) @map("wht_amount") @db.Decimal(15, 2)
  paidAmount      Decimal       @default(0) @map("paid_amount") @db.Decimal(15, 2)
  
  // === VAT Info ===
  vatRate         Decimal?      @map("vat_rate") @db.Decimal(5, 2)
  isVatInclusive  Boolean       @default(true) @map("is_vat_inclusive")
  
  // === WHT Info ===
  hasWht          Boolean       @default(false) @map("has_wht")
  whtRate         Decimal?      @map("wht_rate") @db.Decimal(5, 2)
  
  // === Status ===
  status          BoxStatus     @default(DRAFT)
  docStatus       DocStatus     @default(INCOMPLETE) @map("doc_status")
  paymentStatus   PaymentStatus @default(UNPAID) @map("payment_status")
  
  // === Flags ===
  hasVat          Boolean       @default(true) @map("has_vat")        // คาดว่ามี VAT
  noReceiptReason String?       @map("no_receipt_reason")             // ถ้าไม่มีเอกสาร
  whtSent         Boolean       @default(false) @map("wht_sent")      // ส่ง WHT ให้คู่ค้าแล้ว
  
  // === Foreign Currency ===
  foreignCurrency String?       @map("foreign_currency")  // USD, EUR
  foreignAmount   Decimal?      @map("foreign_amount") @db.Decimal(15, 2)
  exchangeRate    Decimal?      @map("exchange_rate") @db.Decimal(15, 6)
  
  // === Notes ===
  description     String?
  notes           String?
  externalRef     String?       @map("external_ref")
  
  // === Relations ===
  contactId       String?       @map("contact_id")
  categoryId      String?       @map("category_id")
  costCenterId    String?       @map("cost_center_id")
  fiscalPeriodId  String?       @map("fiscal_period_id")
  createdById     String        @map("created_by_id")
  
  // === Linked (for refund/adjustment) ===
  linkedBoxId     String?       @map("linked_box_id")
  linkedBox       Box?          @relation("LinkedBoxes", fields: [linkedBoxId], references: [id])
  linkedFrom      Box[]         @relation("LinkedBoxes")
  
  // === Timestamps ===
  exportedAt      DateTime?     @map("exported_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact       Contact?       @relation(fields: [contactId], references: [id])
  category      Category?      @relation(fields: [categoryId], references: [id])
  costCenter    CostCenter?    @relation(fields: [costCenterId], references: [id])
  fiscalPeriod  FiscalPeriod?  @relation(fields: [fiscalPeriodId], references: [id])
  createdBy     User           @relation("CreatedBy", fields: [createdById], references: [id])
  
  // Child entities
  documents     Document[]     // เอกสารในกล่อง
  payments      Payment[]      // การจ่ายเงิน
  whtTrackings  WhtTracking[]  // WHT tracking
  comments      Comment[]
  activityLogs  ActivityLog[]

  @@unique([organizationId, boxNumber])
  @@index([organizationId, status])
  @@index([organizationId, boxDate])
  @@index([organizationId, boxType])
  @@index([organizationId, docStatus])
  @@index([contactId])
  @@map("boxes")
}

enum BoxType {
  EXPENSE     // รายจ่าย
  INCOME      // รายรับ
  ADJUSTMENT  // ปรับปรุง (refund, CN, DN)
}

enum ExpenseType {
  STANDARD      // มีใบกำกับภาษี (เครม VAT ได้)
  NO_VAT        // ไม่มีใบกำกับภาษี (บิลเงินสด/ร้านไม่จด)
  PETTY_CASH    // เงินสดย่อย
  FOREIGN       // จ่ายต่างประเทศ
}

enum BoxStatus {
  DRAFT           // แบบร่าง
  PENDING_REVIEW  // รอตรวจ
  NEED_INFO       // ขอข้อมูลเพิ่ม
  APPROVED        // อนุมัติแล้ว
  EXPORTED        // Export แล้ว
  CANCELLED       // ยกเลิก
}

enum DocStatus {
  INCOMPLETE  // เอกสารไม่ครบ
  COMPLETE    // เอกสารครบ
  NA          // ไม่ต้องมีเอกสาร
}

enum PaymentStatus {
  UNPAID    // ยังไม่จ่าย
  PARTIAL   // จ่ายบางส่วน
  PAID      // จ่ายครบ
  OVERPAID  // จ่ายเกิน
  REFUNDED  // ได้คืนแล้ว
}

// ============================================
// DOCUMENT (เอกสารในกล่อง)
// 1 Box → หลาย Document
// แต่ละ Document = เอกสารประเภทหนึ่ง
// ============================================

model Document {
  id          String     @id @default(cuid())
  boxId       String     @map("box_id")
  
  // === Type ===
  docType     DocType    @map("doc_type")
  
  // === Details ===
  docNumber   String?    @map("doc_number")  // เลขที่เอกสาร
  docDate     DateTime?  @map("doc_date")
  amount      Decimal?   @db.Decimal(15, 2)
  vatAmount   Decimal?   @map("vat_amount") @db.Decimal(15, 2)
  
  // === Foreign Currency ===
  foreignCurrency String? @map("foreign_currency")
  foreignAmount   Decimal? @map("foreign_amount") @db.Decimal(15, 2)
  
  // === Notes ===
  notes       String?
  
  // === AI Extracted ===
  aiExtracted  Json?      @map("ai_extracted")   // ข้อมูลที่ AI อ่านได้
  aiConfidence Float?     @map("ai_confidence")  // ความมั่นใจ 0-1
  
  // === Timestamps ===
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  box         Box        @relation(fields: [boxId], references: [id], onDelete: Cascade)
  files       DocumentFile[]

  @@index([boxId])
  @@index([docType])
  @@map("documents")
}

// ประเภทเอกสาร (25+ types)
enum DocType {
  // === หลักฐานจ่ายเงิน (Payment Evidence) ===
  SLIP_TRANSFER         // สลิปโอนเงิน
  SLIP_CHEQUE           // สำเนาเช็ค
  BANK_STATEMENT        // Statement ธนาคาร
  CREDIT_CARD_STATEMENT // Statement บัตรเครดิต
  ONLINE_RECEIPT        // Paypal/Stripe
  PETTY_CASH_VOUCHER    // ใบสำคัญจ่ายเงินสด
  
  // === หลักฐานรายจ่าย (Expense Evidence) ===
  TAX_INVOICE           // ใบกำกับภาษี
  TAX_INVOICE_ABB       // ใบกำกับภาษีอย่างย่อ
  RECEIPT               // ใบเสร็จรับเงิน
  CASH_RECEIPT          // บิลเงินสด
  INVOICE               // ใบแจ้งหนี้
  FOREIGN_INVOICE       // Invoice ต่างประเทศ
  CUSTOMS_FORM          // ใบขนสินค้า
  DELIVERY_NOTE         // ใบส่งของ
  
  // === เอกสารปรับปรุง (Adjustment) ===
  CREDIT_NOTE           // ใบลดหนี้
  DEBIT_NOTE            // ใบเพิ่มหนี้
  REFUND_RECEIPT        // หลักฐานคืนเงิน
  
  // === WHT ===
  WHT_SENT              // WHT ที่เราส่งให้
  WHT_RECEIVED          // WHT ที่ได้รับกลับ (signed)
  WHT_INCOMING          // WHT ที่เขาหักเรา
  
  // === ภาษี/ราชการ ===
  TAX_PAYMENT_SLIP      // ใบนำส่งภาษี
  TAX_RECEIPT_GOVT      // ใบเสร็จจากสรรพากร
  SSO_PAYMENT           // ประกันสังคม
  GOVT_RECEIPT          // ใบเสร็จราชการอื่นๆ
  
  // === อื่นๆ ===
  CONTRACT              // สัญญา
  QUOTATION             // ใบเสนอราคา
  PURCHASE_ORDER        // ใบสั่งซื้อ
  CLAIM_FORM            // ใบเบิกเงิน
  OTHER                 // อื่นๆ
}

// ============================================
// DOCUMENT FILE (ไฟล์ของเอกสาร)
// 1 Document → หลายไฟล์ (หน้า-หลัง, หลายหน้า)
// ============================================

model DocumentFile {
  id          String   @id @default(cuid())
  documentId  String   @map("document_id")
  
  fileName    String   @map("file_name")
  fileUrl     String   @map("file_url")
  fileSize    Int      @map("file_size")
  mimeType    String   @map("mime_type")
  checksum    String?  // MD5 for duplicate detection
  pageOrder   Int      @default(1) @map("page_order")
  
  createdAt   DateTime @default(now()) @map("created_at")

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([checksum])
  @@map("document_files")
}

// ============================================
// PAYMENT (การจ่ายเงิน)
// 1 Box → หลาย Payment (จ่ายหลายครั้งได้)
// ============================================

model Payment {
  id          String        @id @default(cuid())
  boxId       String        @map("box_id")
  
  amount      Decimal       @db.Decimal(15, 2)
  paidDate    DateTime      @map("paid_date")
  method      PaymentMethod
  reference   String?       // เลขอ้างอิง
  notes       String?
  
  // Link to slip document (optional)
  documentId  String?       @map("document_id")
  
  createdAt   DateTime      @default(now()) @map("created_at")

  box         Box           @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId])
  @@map("payments")
}

enum PaymentMethod {
  TRANSFER    // โอน
  CHEQUE      // เช็ค
  CASH        // เงินสด
  CREDIT_CARD // บัตรเครดิต
  ONLINE      // Online (Paypal, etc.)
}

// ============================================
// WHT TRACKING (ติดตามหัก ณ ที่จ่าย)
// ============================================

model WhtTracking {
  id              String      @id @default(cuid())
  boxId           String      @map("box_id")
  
  type            WhtType     // outgoing | incoming
  amount          Decimal     @db.Decimal(15, 2)
  rate            Decimal?    @db.Decimal(5, 2)  // 1%, 2%, 3%, 5%
  
  status          WhtStatus   @default(PENDING)
  issuedDate      DateTime?   @map("issued_date")
  sentDate        DateTime?   @map("sent_date")
  sentMethod      WhtSentMethod? @map("sent_method")
  receivedDate    DateTime?   @map("received_date")
  
  // Link to WHT document
  documentId      String?     @map("document_id")
  
  // Counterparty
  contactId       String?     @map("contact_id")
  
  notes           String?
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  box             Box         @relation(fields: [boxId], references: [id], onDelete: Cascade)
  contact         Contact?    @relation(fields: [contactId], references: [id])

  @@index([boxId])
  @@index([status])
  @@map("wht_trackings")
}

enum WhtType {
  OUTGOING  // เราหักเขา (ส่ง WHT ให้ vendor)
  INCOMING  // เขาหักเรา (รับ WHT จากลูกค้า)
}

enum WhtStatus {
  PENDING     // รอดำเนินการ
  ISSUED      // ออกแล้ว
  SENT        // ส่งแล้ว
  CONFIRMED   // ยืนยันแล้ว
  RECEIVED    // ได้รับแล้ว
}

enum WhtSentMethod {
  EMAIL
  MAIL
  HAND_DELIVERY
  OTHER
}

// ============================================
// COMMENTS & ACTIVITY
// ============================================

model Comment {
  id         String   @id @default(cuid())
  boxId      String   @map("box_id")
  userId     String   @map("user_id")
  content    String
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  box        Box      @relation(fields: [boxId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

model ActivityLog {
  id         String   @id @default(cuid())
  boxId      String?  @map("box_id")
  userId     String   @map("user_id")
  action     String
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  box        Box?     @relation(fields: [boxId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

// ============================================
// EXPORT
// ============================================

model ExportHistory {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  exportType     ExportType @map("export_type")
  fileName       String     @map("file_name")
  fileUrl        String?    @map("file_url")
  boxIds         String[]   @map("box_ids")
  boxCount       Int        @map("box_count")
  exportedById   String     @map("exported_by_id")
  createdAt      DateTime   @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("export_histories")
}

enum ExportType {
  EXCEL_GENERIC
  EXCEL_PEAK
  CSV
  ZIP
}

// ============================================
// SAVED FILTERS
// ============================================

model SavedFilter {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  name           String
  filters        Json
  isDefault      Boolean  @default(false) @map("is_default")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, name])
  @@map("saved_filters")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id             String           @id @default(cuid())
  organizationId String           @map("organization_id")
  userId         String           @map("user_id")
  type           NotificationType
  title          String
  message        String
  data           Json?
  isRead         Boolean          @default(false) @map("is_read")
  readAt         DateTime?        @map("read_at")
  createdAt      DateTime         @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([organizationId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  BOX_SUBMITTED       // กล่องใหม่รอตรวจ
  BOX_APPROVED        // กล่องถูก approve
  BOX_REJECTED        // กล่องถูกปฏิเสธ
  BOX_NEED_INFO       // ขอข้อมูลเพิ่ม
  DOCUMENT_ADDED      // มีเอกสารใหม่ในกล่อง
  DUE_DATE_REMINDER   // ใกล้ครบกำหนด
  DUE_DATE_OVERDUE    // เกินกำหนด
  WHT_PENDING         // WHT รอส่ง
  WHT_OVERDUE         // WHT เกินกำหนด
  COMMENT_ADDED       // มี comment ใหม่
  MEMBER_INVITED      // ถูกเชิญเข้าองค์กร
}
