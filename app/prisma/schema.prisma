generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model Organization {
  id                String                 @id @default(cuid())
  name              String
  slug              String                 @unique
  taxId             String?                @map("tax_id")
  address           String?
  phone             String?
  email             String?
  logo              String?
  settings          Json                   @default("{}")
  plan              Plan                   @default(FREE)
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  firmId            String?                @map("firm_id")
  billingEmail      String?                @map("billing_email")
  approvalWorkflows ApprovalWorkflow[]
  bookingEntries    BookingEntry[]
  boxes             Box[]
  categories        Category[]
  contacts          Contact[]
  costCenters       CostCenter[]
  documentTemplates DocumentTemplate[]
  exportHistories   ExportHistory[]
  exportProfiles    ExportProfile[]
  firmAssignments   FirmClientAssignment[]
  firmRelations     FirmClientRelation[]
  fiscalPeriods     FiscalPeriod[]
  integrations      Integration[]
  invitations       Invitation[]
  notifications     Notification[]
  members           OrganizationMember[]
  firm              AccountingFirm?        @relation("FirmClients", fields: [firmId], references: [id])
  savedFilters      SavedFilter[]
  shareLinks        ShareLink[]

  @@index([firmId])
  @@map("organizations")
}

model AccountingFirm {
  id                String                 @id @default(cuid())
  name              String
  slug              String                 @unique
  taxId             String?                @map("tax_id")
  address           String?
  phone             String?
  email             String?
  logo              String?
  settings          Json                   @default("{}")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  description       String?
  billingEmail      String?                @map("billing_email")
  plan              FirmPlan               @default(STARTER)
  clientAssignments FirmClientAssignment[]
  clientRelations   FirmClientRelation[]
  members           FirmMember[]
  invitations       Invitation[]
  clients           Organization[]         @relation("FirmClients")

  @@map("accounting_firms")
}

model FirmMember {
  id                String                 @id @default(cuid())
  firmId            String                 @map("firm_id")
  userId            String                 @map("user_id")
  role              FirmRole               @default(STAFF)
  isActive          Boolean                @default(true) @map("is_active")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  clientAssignments FirmClientAssignment[]
  firm              AccountingFirm         @relation(fields: [firmId], references: [id], onDelete: Cascade)
  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([firmId, userId])
  @@map("firm_members")
}

model FirmClientAssignment {
  id             String         @id @default(cuid())
  firmId         String         @map("firm_id")
  organizationId String         @map("organization_id")
  firmMemberId   String         @map("firm_member_id")
  role           AssignmentRole @default(PRIMARY)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  firm           AccountingFirm @relation(fields: [firmId], references: [id], onDelete: Cascade)
  firmMember     FirmMember     @relation(fields: [firmMemberId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([firmId, organizationId, firmMemberId])
  @@index([firmId])
  @@index([organizationId])
  @@index([firmMemberId])
  @@map("firm_client_assignments")
}

model FirmClientRelation {
  id               String         @id @default(cuid())
  firmId           String         @map("firm_id")
  organizationId   String         @map("organization_id")
  status           RelationStatus @default(PENDING)
  invitedByUserId  String         @map("invited_by_user_id")
  invitedByType    InviterType    @default(BUSINESS)
  invitedAt        DateTime       @default(now()) @map("invited_at")
  respondedAt      DateTime?      @map("responded_at")
  terminatedAt     DateTime?      @map("terminated_at")
  terminatedReason String?        @map("terminated_reason")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  firm             AccountingFirm @relation(fields: [firmId], references: [id], onDelete: Cascade)
  invitedBy        User           @relation("FirmRelationInviter", fields: [invitedByUserId], references: [id])
  organization     Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([firmId, organizationId])
  @@index([firmId])
  @@index([organizationId])
  @@index([status])
  @@map("firm_client_relations")
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  name                String?
  avatarUrl           String?              @map("avatar_url")
  supabaseId          String               @unique @map("supabase_id")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  activityLogs        ActivityLog[]
  bookingEntries      BookingEntry[]       @relation("BookedBy")
  approvals           BoxApproval[]
  boxes               Box[]                @relation("CreatedBy")
  vatVerifiedBoxes    Box[]                @relation("VatVerifiedBy")
  comments            Comment[]
  firmRelationInvites FirmClientRelation[] @relation("FirmRelationInviter")
  firmMemberships     FirmMember[]
  sentInvitations     Invitation[]
  notifications       Notification[]
  memberships         OrganizationMember[]
  savedFilters        SavedFilter[]
  shareLinks          ShareLink[]
  assignedTasks       Task[]               @relation("TaskAssignee")

  @@map("users")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  role           MemberRole   @default(STAFF)
  isActive       Boolean      @default(true) @map("is_active")
  invitedAt      DateTime     @default(now()) @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  bankAccount    String?      @map("bank_account")
  bankName       String?      @map("bank_name")
  visibleName    String?      @map("visible_name")
  boxPayers      BoxPayer[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId, isActive])
  @@map("organization_members")
}

model Invitation {
  id             String           @id @default(cuid())
  code           String           @unique @default(cuid())
  email          String
  organizationId String?          @map("organization_id")
  firmId         String?          @map("firm_id")
  role           String
  invitedById    String           @map("invited_by_id")
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime         @map("expires_at")
  acceptedAt     DateTime?        @map("accepted_at")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  firm           AccountingFirm?  @relation(fields: [firmId], references: [id], onDelete: Cascade)
  invitedBy      User             @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  organization   Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([email])
  @@index([organizationId])
  @@index([firmId])
  @@map("invitations")
}

model Contact {
  id                 String             @id @default(cuid())
  organizationId     String             @map("organization_id")
  name               String
  contactType        ContactType        @default(INDIVIDUAL) @map("contact_type")
  contactRole        ContactRole        @default(VENDOR) @map("contact_role")
  taxId              String?            @map("tax_id")
  branchNo           String?            @map("branch_no")
  address            String?
  phone              String?
  email              String?
  whtApplicable      Boolean            @default(false) @map("wht_applicable")
  defaultWhtRate     Decimal?           @map("default_wht_rate") @db.Decimal(5, 2)
  isActive           Boolean            @default(true) @map("is_active")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  defaultVatRequired Boolean            @default(false) @map("default_vat_required")
  slaRating          Int?               @map("sla_rating")
  avgResponseDays    Float?             @map("avg_response_days")
  lastUsedAt         DateTime?          @map("last_used_at")
  boxes              Box[]
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documentTemplates  DocumentTemplate[]
  whtTrackings       WhtTracking[]

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@map("contacts")
}

model CostCenter {
  id                String             @id @default(cuid())
  organizationId    String             @map("organization_id")
  code              String
  name              String
  description       String?
  isActive          Boolean            @default(true) @map("is_active")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  boxes             Box[]
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documentTemplates DocumentTemplate[]

  @@unique([organizationId, code])
  @@map("cost_centers")
}

model Category {
  id                String             @id @default(cuid())
  organizationId    String             @map("organization_id")
  code              String
  name              String
  categoryType      CategoryType       @default(EXPENSE) @map("category_type")
  peakAccountCode   String?            @map("peak_account_code")
  whtSuggestion     WhtSuggestion      @default(NONE) @map("wht_suggestion")
  defaultWhtRate    Decimal?           @map("default_wht_rate") @db.Decimal(5, 2)
  isActive          Boolean            @default(true) @map("is_active")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  boxes             Box[]
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documentTemplates DocumentTemplate[]

  @@unique([organizationId, code])
  @@map("categories")
}

model FiscalPeriod {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  name           String
  year           Int
  month          Int
  startDate      DateTime     @map("start_date")
  endDate        DateTime     @map("end_date")
  status         PeriodStatus @default(OPEN)
  closedAt       DateTime?    @map("closed_at")
  closedById     String?      @map("closed_by_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  boxes          Box[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, year, month])
  @@map("fiscal_periods")
}

model Box {
  id                  String               @id @default(cuid())
  organizationId      String               @map("organization_id")
  boxNumber           String               @map("box_number")
  title               String?
  boxType             BoxType              @default(EXPENSE) @map("box_type")
  expenseType         ExpenseType?         @map("expense_type")
  boxDate             DateTime             @map("box_date")
  dueDate             DateTime?            @map("due_date")
  totalAmount         Decimal              @default(0) @map("total_amount") @db.Decimal(15, 2)
  vatAmount           Decimal              @default(0) @map("vat_amount") @db.Decimal(15, 2)
  whtAmount           Decimal              @default(0) @map("wht_amount") @db.Decimal(15, 2)
  paidAmount          Decimal              @default(0) @map("paid_amount") @db.Decimal(15, 2)
  vatRate             Decimal?             @map("vat_rate") @db.Decimal(5, 2)
  isVatInclusive      Boolean              @default(true) @map("is_vat_inclusive")
  hasWht              Boolean              @default(false) @map("has_wht")
  whtRate             Decimal?             @map("wht_rate") @db.Decimal(5, 2)
  status              BoxStatus            @default(DRAFT)
  docStatus           DocStatus            @default(INCOMPLETE) @map("doc_status")
  paymentStatus       PaymentStatus        @default(UNPAID) @map("payment_status")
  hasVat              Boolean              @default(true) @map("has_vat")
  vatDocStatus        VatDocStatus         @default(MISSING) @map("vat_doc_status")
  vatVerifiedAt       DateTime?            @map("vat_verified_at")
  vatVerifiedById     String?              @map("vat_verified_by_id")
  whtDocStatus        WhtDocStatus         @default(MISSING) @map("wht_doc_status")
  naDocTypes          String[]             @default([]) @map("na_doc_types")
  whtDueDate          DateTime?            @map("wht_due_date")
  whtOverdue          Boolean              @default(false) @map("wht_overdue")
  whtSent             Boolean              @default(false) @map("wht_sent")
  possibleDuplicate   Boolean              @default(false) @map("possible_duplicate")
  duplicateReason     String?              @map("duplicate_reason")
  paymentMode         PaymentMode          @default(COMPANY_PAID) @map("payment_mode")
  reimbursementStatus ReimbursementStatus? @map("reimbursement_status")
  isLateDocs          Boolean              @default(false) @map("is_late_docs")
  noReceiptReason     String?              @map("no_receipt_reason")
  foreignCurrency     String?              @map("foreign_currency")
  foreignAmount       Decimal?             @map("foreign_amount") @db.Decimal(15, 2)
  exchangeRate        Decimal?             @map("exchange_rate") @db.Decimal(15, 6)
  description         String?
  notes               String?
  externalRef         String?              @map("external_ref")
  contactId           String?              @map("contact_id")
  categoryId          String?              @map("category_id")
  costCenterId        String?              @map("cost_center_id")
  fiscalPeriodId      String?              @map("fiscal_period_id")
  createdById         String               @map("created_by_id")
  bookingEntryId      String?              @map("booking_entry_id")
  linkedBoxId         String?              @map("linked_box_id")
  submittedAt         DateTime?            @map("submitted_at")
  reviewedAt          DateTime?            @map("reviewed_at")
  bookedAt            DateTime?            @map("booked_at")
  exportedAt          DateTime?            @map("exported_at")
  archivedAt          DateTime?            @map("archived_at")
  lockedAt            DateTime?            @map("locked_at")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  workflowId          String?              @map("workflow_id")
  activityLogs        ActivityLog[]
  approvals           BoxApproval[]
  payers              BoxPayer[]
  bookingEntry        BookingEntry?        @relation(fields: [bookingEntryId], references: [id])
  category            Category?            @relation(fields: [categoryId], references: [id])
  contact             Contact?             @relation(fields: [contactId], references: [id])
  costCenter          CostCenter?          @relation(fields: [costCenterId], references: [id])
  createdBy           User                 @relation("CreatedBy", fields: [createdById], references: [id])
  fiscalPeriod        FiscalPeriod?        @relation(fields: [fiscalPeriodId], references: [id])
  linkedBox           Box?                 @relation("LinkedBoxes", fields: [linkedBoxId], references: [id])
  linkedFrom          Box[]                @relation("LinkedBoxes")
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vatVerifiedBy       User?                @relation("VatVerifiedBy", fields: [vatVerifiedById], references: [id])
  workflow            ApprovalWorkflow?    @relation("BoxWorkflow", fields: [workflowId], references: [id])
  comments            Comment[]
  documents           Document[]
  payments            Payment[]
  shareLinks          ShareLink[]
  tasks               Task[]
  whtTrackings        WhtTracking[]

  @@unique([organizationId, boxNumber])
  @@index([organizationId, status])
  @@index([organizationId, boxDate])
  @@index([organizationId, boxType])
  @@index([organizationId, docStatus])
  @@index([organizationId, whtOverdue])
  @@index([organizationId, possibleDuplicate])
  @@index([contactId])
  @@index([bookingEntryId])
  @@index([workflowId])
  @@index([organizationId, createdAt])
  @@index([status, docStatus])
  @@index([categoryId])
  @@index([fiscalPeriodId])
  @@index([hasWht, whtDocStatus])
  @@map("boxes")
}

model BoxPayer {
  id                  String              @id @default(cuid())
  boxId               String              @map("box_id")
  payerType           PayerType           @map("payer_type")
  memberId            String?             @map("member_id")
  amount              Decimal             @db.Decimal(15, 2)
  reimbursementStatus ReimbursementStatus @default(PENDING) @map("reimbursement_status")
  reimbursedAt        DateTime?           @map("reimbursed_at")
  reimbursementNote   String?             @map("reimbursement_note")
  paidDate            DateTime?           @map("paid_date")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  box                 Box                 @relation(fields: [boxId], references: [id], onDelete: Cascade)
  member              OrganizationMember? @relation(fields: [memberId], references: [id])

  @@index([boxId])
  @@index([memberId])
  @@index([reimbursementStatus])
  @@index([memberId, reimbursementStatus])
  @@map("box_payers")
}

model Task {
  id              String     @id @default(cuid())
  boxId           String     @map("box_id")
  organizationId  String     @map("organization_id")
  taskType        TaskType   @map("task_type")
  status          TaskStatus @default(OPEN)
  title           String
  description     String?
  dueDate         DateTime?  @map("due_date")
  assigneeId      String?    @map("assignee_id")
  reminderCount   Int        @default(0) @map("reminder_count")
  lastReminderAt  DateTime?  @map("last_reminder_at")
  escalatedAt     DateTime?  @map("escalated_at")
  escalationLevel Int        @default(0) @map("escalation_level")
  completedAt     DateTime?  @map("completed_at")
  completedById   String?    @map("completed_by_id")
  cancelledAt     DateTime?  @map("cancelled_at")
  cancelReason    String?    @map("cancel_reason")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  assignee        User?      @relation("TaskAssignee", fields: [assigneeId], references: [id])
  box             Box        @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([assigneeId])
  @@map("tasks")
}

model BookingEntry {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  entryNumber    String       @map("entry_number")
  description    String?
  totalAmount    Decimal      @default(0) @map("total_amount") @db.Decimal(15, 2)
  bookedAt       DateTime     @map("booked_at")
  bookedById     String       @map("booked_by_id")
  exportedAt     DateTime?    @map("exported_at")
  exportProfile  String?      @map("export_profile")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  bookedBy       User         @relation("BookedBy", fields: [bookedById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  boxes          Box[]

  @@unique([organizationId, entryNumber])
  @@index([organizationId, bookedAt])
  @@map("booking_entries")
}

model Document {
  id              String         @id @default(cuid())
  boxId           String         @map("box_id")
  docType         DocType        @map("doc_type")
  docNumber       String?        @map("doc_number")
  docDate         DateTime?      @map("doc_date")
  amount          Decimal?       @db.Decimal(15, 2)
  vatAmount       Decimal?       @map("vat_amount") @db.Decimal(15, 2)
  foreignCurrency String?        @map("foreign_currency")
  foreignAmount   Decimal?       @map("foreign_amount") @db.Decimal(15, 2)
  notes           String?
  aiExtracted     Json?          @map("ai_extracted")
  aiConfidence    Float?         @map("ai_confidence")
  isLateDocs      Boolean        @default(false) @map("is_late_docs")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  pageOrder       Int            @default(0) @map("page_order")
  files           DocumentFile[]
  box             Box            @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId])
  @@index([docType])
  @@index([boxId, docType])
  @@map("documents")
}

model DocumentFile {
  id         String   @id @default(cuid())
  documentId String   @map("document_id")
  fileName   String   @map("file_name")
  fileUrl    String   @map("file_url")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  checksum   String?
  pageOrder  Int      @default(1) @map("page_order")
  createdAt  DateTime @default(now()) @map("created_at")
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([checksum])
  @@map("document_files")
}

model Payment {
  id         String        @id @default(cuid())
  boxId      String        @map("box_id")
  amount     Decimal       @db.Decimal(15, 2)
  paidDate   DateTime      @map("paid_date")
  method     PaymentMethod
  reference  String?
  notes      String?
  documentId String?       @map("document_id")
  createdAt  DateTime      @default(now()) @map("created_at")
  box        Box           @relation(fields: [boxId], references: [id], onDelete: Cascade)

  @@index([boxId])
  @@map("payments")
}

model WhtTracking {
  id           String         @id @default(cuid())
  boxId        String         @map("box_id")
  type         WhtType
  amount       Decimal        @db.Decimal(15, 2)
  rate         Decimal?       @db.Decimal(5, 2)
  status       WhtStatus      @default(PENDING)
  issuedDate   DateTime?      @map("issued_date")
  sentDate     DateTime?      @map("sent_date")
  sentMethod   WhtSentMethod? @map("sent_method")
  receivedDate DateTime?      @map("received_date")
  dueDate      DateTime?      @map("due_date")
  isOverdue    Boolean        @default(false) @map("is_overdue")
  documentId   String?        @map("document_id")
  contactId    String?        @map("contact_id")
  notes        String?
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  box          Box            @relation(fields: [boxId], references: [id], onDelete: Cascade)
  contact      Contact?       @relation(fields: [contactId], references: [id])

  @@index([boxId])
  @@index([status])
  @@index([isOverdue])
  @@map("wht_trackings")
}

model Comment {
  id         String    @id @default(cuid())
  boxId      String    @map("box_id")
  userId     String    @map("user_id")
  content    String
  isInternal Boolean   @default(false) @map("is_internal")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  editedAt   DateTime? @map("edited_at")
  mentions   String[]  @default([])
  parentId   String?   @map("parent_id")
  box        Box       @relation(fields: [boxId], references: [id], onDelete: Cascade)
  parent     Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[] @relation("CommentReplies")
  user       User      @relation(fields: [userId], references: [id])

  @@index([boxId, createdAt])
  @@index([parentId])
  @@map("comments")
}

model ActivityLog {
  id        String   @id @default(cuid())
  boxId     String?  @map("box_id")
  userId    String   @map("user_id")
  action    String
  details   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")
  box       Box?     @relation(fields: [boxId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([boxId])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("activity_logs")
}

model ExportHistory {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  exportType     ExportType   @map("export_type")
  exportProfile  String?      @map("export_profile")
  fileName       String       @map("file_name")
  fileUrl        String?      @map("file_url")
  boxIds         String[]     @map("box_ids")
  boxCount       Int          @map("box_count")
  exportedById   String       @map("exported_by_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@map("export_histories")
}

model ExportProfile {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  name           String
  description    String?
  isDefault      Boolean      @default(false) @map("is_default")
  isSystem       Boolean      @default(false) @map("is_system")
  columns        Json         @default("[]")
  dateFormat     String       @default("DD/MM/YYYY") @map("date_format")
  numberFormat   String       @default("COMMA") @map("number_format")
  includeVat     Boolean      @default(true) @map("include_vat")
  includeWht     Boolean      @default(true) @map("include_wht")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@map("export_profiles")
}

model SavedFilter {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  name           String
  filters        Json
  isDefault      Boolean      @default(false) @map("is_default")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, name])
  @@map("saved_filters")
}

model Notification {
  id             String           @id @default(cuid())
  organizationId String           @map("organization_id")
  userId         String           @map("user_id")
  type           NotificationType
  title          String
  message        String
  data           Json?
  isRead         Boolean          @default(false) @map("is_read")
  readAt         DateTime?        @map("read_at")
  createdAt      DateTime         @default(now()) @map("created_at")
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([organizationId, createdAt])
  @@map("notifications")
}

model ShareLink {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  token          String       @unique
  name           String?
  scope          ShareScope   @default(BOX)
  boxId          String?      @map("box_id")
  boxIds         String[]     @map("box_ids")
  periodMonth    Int?         @map("period_month")
  periodYear     Int?         @map("period_year")
  password       String?
  expiresAt      DateTime?    @map("expires_at")
  maxViews       Int?         @map("max_views")
  viewCount      Int          @default(0) @map("view_count")
  showAmounts    Boolean      @default(true) @map("show_amounts")
  showContacts   Boolean      @default(true) @map("show_contacts")
  allowDownload  Boolean      @default(true) @map("allow_download")
  createdById    String       @map("created_by_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  lastAccessedAt DateTime?    @map("last_accessed_at")
  box            Box?         @relation(fields: [boxId], references: [id], onDelete: Cascade)
  createdBy      User         @relation(fields: [createdById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("share_links")
}

model Integration {
  id              String             @id @default(cuid())
  organizationId  String             @map("organization_id")
  type            IntegrationType
  name            String
  isActive        Boolean            @default(true) @map("is_active")
  config          Json               @default("{}")
  events          NotificationType[]
  lastTriggeredAt DateTime?          @map("last_triggered_at")
  triggerCount    Int                @default(0) @map("trigger_count")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, type])
  @@map("integrations")
}

model WebhookLog {
  id            String           @id @default(cuid())
  integrationId String           @map("integration_id")
  eventType     NotificationType @map("event_type")
  payload       Json
  status        String
  responseCode  Int?             @map("response_code")
  responseBody  String?          @map("response_body")
  errorMessage  String?          @map("error_message")
  createdAt     DateTime         @default(now()) @map("created_at")

  @@index([integrationId, createdAt])
  @@map("webhook_logs")
}

model ApprovalWorkflow {
  id             String         @id @default(cuid())
  organizationId String         @map("organization_id")
  name           String
  description    String?
  isDefault      Boolean        @default(false) @map("is_default")
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  steps          ApprovalStep[]
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  boxes          Box[]          @relation("BoxWorkflow")

  @@index([organizationId, isActive])
  @@map("approval_workflows")
}

model ApprovalStep {
  id            String           @id @default(cuid())
  workflowId    String           @map("workflow_id")
  order         Int
  name          String
  approverType  ApproverType     @map("approver_type")
  approverValue String?          @map("approver_value")
  autoApprove   Boolean          @default(false) @map("auto_approve")
  threshold     Decimal?
  createdAt     DateTime         @default(now()) @map("created_at")
  workflow      ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  approvals     BoxApproval[]

  @@unique([workflowId, order])
  @@map("approval_steps")
}

model BoxApproval {
  id         String         @id @default(cuid())
  boxId      String         @map("box_id")
  stepId     String         @map("step_id")
  status     ApprovalStatus @default(PENDING)
  approvedBy String?        @map("approved_by")
  comment    String?
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")
  approver   User?          @relation(fields: [approvedBy], references: [id])
  box        Box            @relation(fields: [boxId], references: [id], onDelete: Cascade)
  step       ApprovalStep   @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@unique([boxId, stepId])
  @@index([boxId, status])
  @@map("box_approvals")
}

model DocumentTemplate {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  name           String
  contactId      String?      @map("contact_id")
  docType        DocType      @map("doc_type")
  categoryId     String?      @map("category_id")
  costCenterId   String?      @map("cost_center_id")
  expenseType    ExpenseType? @map("expense_type")
  expectedAmount Decimal?     @map("expected_amount") @db.Decimal(15, 2)
  amountVariance Decimal      @default(0.1) @map("amount_variance") @db.Decimal(5, 2)
  description    String?
  isActive       Boolean      @default(true) @map("is_active")
  usageCount     Int          @default(0) @map("usage_count")
  lastUsedAt     DateTime?    @map("last_used_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  category       Category?    @relation(fields: [categoryId], references: [id])
  contact        Contact?     @relation(fields: [contactId], references: [id])
  costCenter     CostCenter?  @relation(fields: [costCenterId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, isActive])
  @@index([contactId])
  @@map("document_templates")
}

enum FirmPlan {
  STARTER
  PRO
  ENTERPRISE
}

enum AssignmentRole {
  PRIMARY
  SUPPORT
}

enum RelationStatus {
  PENDING
  ACTIVE
  TERMINATED
}

enum InviterType {
  BUSINESS
  FIRM
}

enum FirmRole {
  OWNER
  ADMIN
  ACCOUNTANT
  STAFF
}

enum Plan {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
}

enum MemberRole {
  OWNER
  ADMIN
  ACCOUNTING
  STAFF
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ContactType {
  INDIVIDUAL
  COMPANY
}

enum ContactRole {
  VENDOR
  CUSTOMER
  BOTH
}

enum CategoryType {
  EXPENSE
  INCOME
}

enum WhtSuggestion {
  NONE
  SOMETIMES
  USUALLY
}

enum PeriodStatus {
  OPEN
  CLOSING
  CLOSED
}

enum BoxType {
  EXPENSE
  INCOME
}

enum ExpenseType {
  STANDARD
  NO_VAT
}

// Simplified 4-status system
enum BoxStatus {
  DRAFT       // ร่าง - เพิ่งสร้าง ยังไม่มีเอกสาร
  PREPARING   // เตรียมเอกสาร - กำลังอัปโหลดเอกสาร
  SUBMITTED   // ส่งแล้ว - ส่งให้บัญชีแล้ว รอตรวจ
  NEED_DOCS   // ต้องเพิ่มเอกสาร - บัญชีขอเอกสารเพิ่ม
  COMPLETED   // เสร็จสิ้น - ลงบัญชีเรียบร้อย
}

enum VatDocStatus {
  MISSING
  RECEIVED
  VERIFIED
  NA
}

enum WhtDocStatus {
  MISSING
  REQUEST_SENT
  RECEIVED
  VERIFIED
  NA
}

enum DocStatus {
  INCOMPLETE
  COMPLETE
  NA
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  OVERPAID
  REFUNDED
}

enum PaymentMode {
  COMPANY_PAID
  EMPLOYEE_ADVANCE
}

enum ReimbursementStatus {
  NONE
  PENDING
  REIMBURSED
}

enum PayerType {
  COMPANY
  PETTY_CASH
  MEMBER
}

enum TaskType {
  VAT_INVOICE
  WHT_CERTIFICATE
  GENERAL_DOC
  FOLLOW_UP
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
  CANCELLED
}

enum DocType {
  SLIP_TRANSFER
  SLIP_CHEQUE
  BANK_STATEMENT
  CREDIT_CARD_STATEMENT
  ONLINE_RECEIPT
  PETTY_CASH_VOUCHER
  TAX_INVOICE
  TAX_INVOICE_ABB
  RECEIPT
  CASH_RECEIPT
  INVOICE
  FOREIGN_INVOICE
  CUSTOMS_FORM
  DELIVERY_NOTE
  CREDIT_NOTE
  DEBIT_NOTE
  REFUND_RECEIPT
  WHT_SENT
  WHT_RECEIVED
  WHT_INCOMING
  TAX_PAYMENT_SLIP
  TAX_RECEIPT_GOVT
  SSO_PAYMENT
  GOVT_RECEIPT
  CONTRACT
  QUOTATION
  PURCHASE_ORDER
  CLAIM_FORM
  OTHER
}

enum PaymentMethod {
  TRANSFER
  CHEQUE
  CASH
  CREDIT_CARD
  ONLINE
}

enum WhtType {
  OUTGOING
  INCOMING
}

enum WhtStatus {
  PENDING
  ISSUED
  SENT
  CONFIRMED
  RECEIVED
}

enum WhtSentMethod {
  EMAIL
  MAIL
  HAND_DELIVERY
  OTHER
}

enum ExportType {
  EXCEL_GENERIC
  EXCEL_PEAK
  EXCEL_FLOWACCOUNT
  EXCEL_EXPRESS
  CSV
  ZIP
}

enum NotificationType {
  BOX_SUBMITTED
  BOX_IN_REVIEW
  BOX_NEED_MORE_DOCS
  BOX_READY_TO_BOOK
  BOX_BOOKED
  BOX_ARCHIVED
  BOX_CANCELLED
  DOCUMENT_ADDED
  TASK_ASSIGNED
  TASK_REMINDER
  TASK_ESCALATED
  TASK_COMPLETED
  DUE_DATE_REMINDER
  DUE_DATE_OVERDUE
  WHT_PENDING
  WHT_OVERDUE
  WHT_RECEIVED
  COMMENT_ADDED
  MEMBER_INVITED
  PERIOD_CLOSING
  PERIOD_CLOSED
}

enum ShareScope {
  BOX
  MULTIPLE
  PERIOD
  ENTRY
}

enum IntegrationType {
  LINE_OA
  LINE_NOTIFY
  SLACK
  DISCORD
  CUSTOM_WEBHOOK
  EMAIL
}

enum ApproverType {
  ROLE
  USER
  ANY
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}
